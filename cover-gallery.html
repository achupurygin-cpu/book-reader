<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –æ–±–ª–æ–∂–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--tg-theme-hint-color, #e0e0e0);
            border-top-color: var(--tg-theme-button-color, #3390ec);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .covers-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .cover-card {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            cursor: pointer;
            transition: all 0.3s ease;
            aspect-ratio: 2/3;
        }

        .cover-card.loading {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cover-card .loading-spinner {
            width: 40px;
            height: 40px;
            margin: 0;
        }

        .cover-card.selected {
            outline: 3px solid var(--tg-theme-button-color, #3390ec);
            outline-offset: -3px;
        }

        .cover-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .cover-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            padding: 12px;
            color: white;
        }

        .cover-style {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .checkmark {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: var(--tg-theme-button-color, #3390ec);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .cover-card.selected .checkmark {
            display: flex;
        }

        .bottom-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            display: flex;
            gap: 12px;
        }

        .button {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .button-regenerate {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000);
        }

        .button-regenerate:active {
            opacity: 0.7;
        }

        .button-select {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .button-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-select:not(:disabled):active {
            opacity: 0.8;
        }

        .regenerating-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .regenerating-overlay.active {
            display: flex;
        }

        .regenerating-content {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            max-width: 300px;
        }

        .regenerating-content .loading-spinner {
            margin: 0 auto 20px;
        }

        .regenerating-content h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .regenerating-content p {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-icon">üé®</div>
        <h1>–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–æ–∂–∫—É</h1>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –≤–∞—à–µ–π –∫–Ω–∏–≥–∏</p>
    </div>

    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–ª–æ–∂–∫–∏...</p>
    </div>

    <div class="covers-grid" id="coversGrid" style="display: none;"></div>

    <div class="bottom-buttons">
        <button class="button button-regenerate" id="regenerateBtn">
            <span>üîÑ</span>
            <span>–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –≤—Å—ë</span>
        </button>
        <button class="button button-select" id="selectBtn" disabled>
            <span>‚úÖ</span>
            <span>–í—ã–±—Ä–∞—Ç—å</span>
        </button>
    </div>

    <div class="regenerating-overlay" id="regeneratingOverlay">
        <div class="regenerating-content">
            <div class="loading-spinner"></div>
            <h3>–°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ –æ–±–ª–æ–∂–∫–∏...</h3>
            <p>–≠—Ç–æ –∑–∞–π–º—ë—Ç ~30 —Å–µ–∫—É–Ω–¥</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.show();
        tg.BackButton.onClick(() => tg.close());

        const API_BASE = 'https://fignetic-n8n.ru/webhook';
        const GET_COVERS_URL = `${API_BASE}/c535da09-89bc-4090-97ce-ac693bdc40e3`;
        const SELECT_COVER_URL = `${API_BASE}/ccd382e4-7bac-4694-b9a6-1c26782d3ff7`;
        
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('book_id');
        const userId = urlParams.get('user_id') || tg.initDataUnsafe?.user?.id;

        let selectedCoverId = null;
        let isRegenerating = false;
        let pollingInterval = null;

        const styleNames = {
            minimalism: '–ú–∏–Ω–∏–º–∞–ª–∏–∑–º',
            realism: '–†–µ–∞–ª–∏–∑–º',
            '3d': '3D –†–µ–Ω–¥–µ—Ä',
            watercolor: '–ê–∫–≤–∞—Ä–µ–ª—å'
        };

        async function loadCovers() {
            try {
                const response = await fetch(`${GET_COVERS_URL}?book_id=${bookId}`);
                const data = await response.json();

                if (data.success && data.covers && data.covers.length > 0) {
                    displayCovers(data.covers);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('coversGrid').style.display = 'grid';
                    
                    if (isRegenerating) {
                        stopPolling();
                        hideRegeneratingOverlay();
                        tg.showAlert('‚úÖ –ù–æ–≤—ã–µ –æ–±–ª–æ–∂–∫–∏ –≥–æ—Ç–æ–≤—ã!');
                    }
                } else if (!isRegenerating) {
                    throw new Error('No covers found');
                }
            } catch (error) {
                console.error('Error loading covers:', error);
                if (!isRegenerating) {
                    tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–µ–∫');
                }
            }
        }

        function displayCovers(covers) {
            const grid = document.getElementById('coversGrid');
            grid.innerHTML = '';

            covers.forEach(cover => {
                const card = document.createElement('div');
                card.className = 'cover-card';
                card.dataset.coverId = cover.id;

                const styleName = cover.generation_params?.style || 'unknown';
                const displayStyle = styleNames[styleName] || styleName;

                card.innerHTML = `
                    <img src="${cover.s3_url}" alt="Cover" class="cover-image">
                    <div class="cover-overlay">
                        <div class="cover-style">${displayStyle}</div>
                    </div>
                    <div class="checkmark">‚úì</div>
                `;

                card.addEventListener('click', () => selectCover(cover.id));
                grid.appendChild(card);
            });
        }

        function selectCover(coverId) {
            selectedCoverId = coverId;
            
            document.querySelectorAll('.cover-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const selectedCard = document.querySelector(`[data-cover-id="${coverId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            document.getElementById('selectBtn').disabled = false;
        }

        async function confirmSelection() {
            if (!selectedCoverId) return;

            try {
                const response = await fetch(SELECT_COVER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        book_id: parseInt(bookId),
                        user_id: parseInt(userId),
                        action: 'select',
                        cover_id: parseInt(selectedCoverId),
                        telegram_data: tg.initDataUnsafe
                    })
                });

                const data = await response.json();

                if (data.success) {
                    tg.showAlert('‚úÖ –û–±–ª–æ–∂–∫–∞ –≤—ã–±—Ä–∞–Ω–∞!', () => {
                        tg.close();
                    });
                } else {
                    throw new Error(data.message || 'Selection failed');
                }
            } catch (error) {
                console.error('Error selecting cover:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –æ–±–ª–æ–∂–∫–∏');
            }
        }

        async function regenerateCovers() {
            if (isRegenerating) return;

            const confirmed = await new Promise(resolve => {
                tg.showConfirm(
                    '–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –≤—Å–µ –æ–±–ª–æ–∂–∫–∏?\n\n–¢–µ–∫—É—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.',
                    resolve
                );
            });

            if (!confirmed) return;

            isRegenerating = true;
            showRegeneratingOverlay();

            try {
                const response = await fetch(SELECT_COVER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        book_id: parseInt(bookId),
                        user_id: parseInt(userId),
                        action: 'regenerate',
                        telegram_data: tg.initDataUnsafe
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showLoadingCovers();
                    startPolling();
                } else {
                    throw new Error(data.message || 'Regeneration failed');
                }
            } catch (error) {
                console.error('Error regenerating covers:', error);
                hideRegeneratingOverlay();
                isRegenerating = false;
                tg.showAlert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–±–ª–æ–∂–µ–∫');
            }
        }

        function showRegeneratingOverlay() {
            document.getElementById('regeneratingOverlay').classList.add('active');
        }

        function hideRegeneratingOverlay() {
            document.getElementById('regeneratingOverlay').classList.remove('active');
        }

        function showLoadingCovers() {
            const grid = document.getElementById('coversGrid');
            grid.innerHTML = '';
            grid.style.display = 'grid';
            
            for (let i = 0; i < 4; i++) {
                const card = document.createElement('div');
                card.className = 'cover-card loading';
                card.innerHTML = '<div class="loading-spinner"></div>';
                grid.appendChild(card);
            }
        }

        function startPolling() {
            pollingInterval = setInterval(() => {
                loadCovers();
            }, 2000);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            isRegenerating = false;
        }

        document.getElementById('selectBtn').addEventListener('click', confirmSelection);
        document.getElementById('regenerateBtn').addEventListener('click', regenerateCovers);

        loadCovers();
    </script>
</body>
</html>
