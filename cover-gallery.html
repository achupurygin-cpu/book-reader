<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–í—ã–±–æ—Ä –æ–±–ª–æ–∂–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
        }

        .covers-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .cover-card {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .cover-card.selected {
            border-color: var(--tg-theme-button-color, #3390ec);
            box-shadow: 0 4px 12px rgba(51, 144, 236, 0.3);
        }

        .cover-image {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
            display: block;
        }

        .cover-info {
            padding: 12px;
        }

        .cover-style {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 4px;
        }

        .cover-prompt {
            font-size: 13px;
            line-height: 1.4;
            color: var(--tg-theme-text-color, #000);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--tg-theme-hint-color, #ddd);
            border-top-color: var(--tg-theme-button-color, #3390ec);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            text-align: center;
            padding: 40px 20px;
            color: #ff3b30;
        }

        .bottom-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-bg-color, #fff);
            padding: 12px 16px;
            border-top: 1px solid var(--tg-theme-hint-color, #ddd);
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé® –í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–æ–∂–∫—É</h1>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –≤–∞—à–µ–π –∫–Ω–∏–≥–∏</p>
    </div>

    <div id="coversContainer" class="loading">
        <div class="loading-spinner"></div>
        <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–ª–æ–∂–∫–∏...</p>
    </div>

    <div class="bottom-buttons">
        <button class="btn btn-secondary" onclick="regenerateAll()">üîÑ –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –≤—Å—ë</button>
        <button class="btn btn-primary" id="selectBtn" onclick="selectCover()" disabled>‚úÖ –í—ã–±—Ä–∞—Ç—å</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const GET_COVERS_URL = 'https://fignetic-n8n.ru/webhook/c535da09-89bc-4090-97ce-ac693bdc40e3';
        const SELECT_COVER_URL = 'https://fignetic-n8n.ru/webhook/ccd382e4-7bac-4694-b9a6-1c26782d3ff7';
        
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('book_id');

        let selectedCoverId = null;
        let userData = null;

        if (tg.initDataUnsafe?.user) {
            userData = tg.initDataUnsafe.user;
        }

        async function loadCovers() {
            if (!bookId) {
                showError('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω ID –∫–Ω–∏–≥–∏');
                return;
            }

            try {
                const response = await fetch(`${GET_COVERS_URL}?book_id=${bookId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load covers');
                }

                const data = await response.json();
                
                if (!data.success || !data.covers || data.covers.length === 0) {
                    showError('‚ùå –û–±–ª–æ–∂–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    return;
                }

                renderCovers(data.covers);
            } catch (error) {
                console.error('Error loading covers:', error);
                showError('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–µ–∫');
            }
        }

        function renderCovers(covers) {
            const container = document.getElementById('coversContainer');
            container.className = 'covers-grid';
            container.innerHTML = '';

            const styleNames = {
                'minimalist': '–ú–∏–Ω–∏–º–∞–ª–∏–∑–º',
                'realistic': '–†–µ–∞–ª–∏–∑–º',
                'illustrated': '–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è',
                'cinematic': '–ö–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ'
            };

            covers.forEach((cover, index) => {
                const card = document.createElement('div');
                card.className = 'cover-card';
                card.onclick = () => toggleCover(cover.id, card);

                const style = cover.generation_params?.style || 'unknown';
                const prompt = cover.prompt?.substring(0, 150) || '–ü—Ä–æ–º–ø—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';

                card.innerHTML = `
                    <img src="${cover.s3_url}" alt="Cover ${cover.id}" class="cover-image" loading="lazy">
                    <div class="cover-info">
                        <div class="cover-style">${styleNames[style] || '–í–∞—Ä–∏–∞–Ω—Ç ' + (index + 1)}</div>
                        <div class="cover-prompt">${prompt}...</div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function toggleCover(coverId, cardElement) {
            document.querySelectorAll('.cover-card').forEach(card => {
                card.classList.remove('selected');
            });

            cardElement.classList.add('selected');
            selectedCoverId = coverId;

            document.getElementById('selectBtn').disabled = false;

            tg.HapticFeedback.impactOccurred('medium');
        }

        async function selectCover() {
            if (!selectedCoverId) {
                tg.showAlert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–æ–∂–∫—É');
                return;
            }

            try {
                const payload = {
                    book_id: parseInt(bookId),
                    cover_id: selectedCoverId,
                    action: 'select',
                    user_id: userData?.id,
                    telegram_data: { user: userData }
                };

                const response = await fetch(SELECT_COVER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    tg.showAlert('‚úÖ –û–±–ª–æ–∂–∫–∞ –≤—ã–±—Ä–∞–Ω–∞!', () => {
                        tg.close();
                    });
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Error selecting cover:', error);
                tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ–±–ª–æ–∂–∫–∏');
            }
        }

        async function regenerateAll() {
            tg.showConfirm('üîÑ –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –≤—Å–µ –æ–±–ª–æ–∂–∫–∏ –∑–∞–Ω–æ–≤–æ?', async (confirmed) => {
                if (!confirmed) return;

                try {
                    const payload = {
                        book_id: parseInt(bookId),
                        action: 'regenerate',
                        user_id: userData?.id,
                        telegram_data: { user: userData }
                    };

                    const response = await fetch(SELECT_COVER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    tg.showAlert('üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞!', () => {
                        tg.close();
                    });
                } catch (error) {
                    console.error('Error regenerating:', error);
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
                }
            });
        }

        function showError(message) {
            const container = document.getElementById('coversContainer');
            container.className = 'error';
            container.innerHTML = `<p>${message}</p>`;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–ª–æ–∂–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        loadCovers();
    </script>
</body>
</html>
